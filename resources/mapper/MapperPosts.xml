<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper 
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">



<mapper namespace="com.mycom.sixclub.service.dao.PostsDAO">
	<!-- 게시글 총 개수 가져오기 -->
	<select id="getAllContents" resultType="PostsVO">
		SELECT * FROM (
			SELECT ROWNUM AS rnum, pid, title, puser_no, pd, puser_id, secret, attachment FROM (
				SELECT p.pid, p.title, p.puser_no, p.pd, u.user_id AS puser_id, secret, attachment
				FROM posts p
				JOIN users u ON p.puser_no = u.user_no
				ORDER BY p.pid DESC
			)
			WHERE ROWNUM &lt;= #{endRow}
		)
		WHERE rnum &gt;= #{startRow}
	</select>


	<!-- 게시글 불러오기 -->
	<select id="getContents" resultType="PostsVO">
		SELECT pid, title, pcontents, puser_no, pd, user_id AS puser_id, attachment, secret
		FROM posts
		JOIN users
		ON puser_no = user_no
		WHERE pid = #{pid}
	</select>

	<!-- 게시글 개수 가져오기 -->
	<select id="getPostCount" resultType="int">
		SELECT COUNT(*) FROM posts
	</select>

	<!-- 게시글 저장하기 -->
	<insert id="insertPost">
		INSERT INTO posts (title, pcontents, puser_no, pd, secret, attachment)
		VALUES (#{title}, #{pcontents}, #{puser_no}, SYSDATE, #{secret}, #{attachment, jdbcType=NULL})
	</insert>

	<!-- 게시글 수정하기 -->
	<update id="updatePost">
		UPDATE posts
		SET title=#{title}, pcontents=#{pcontents}, secret=#{secret}, attachment=#{attachment}
		WHERE pid=#{pid}
	</update>

	<!-- 게시글 삭제하기 -->
	<delete id="deletePost">
		DELETE FROM posts WHERE pid=#{pid}
	</delete>

	<!-- 댓글 불러오기 -->
	<select id="getComments" resultType="CommentsVO">
		SELECT cid, ccid, ccontents, cuser_no, cd, user_id AS cuser_id
		FROM comments
		JOIN users
		ON cuser_no = user_no
		WHERE pid = #{pid}
		START WITH ccid IS NULL 
		CONNECT BY PRIOR cid = ccid 
		ORDER SIBLINGS BY cid ASC
	</select>
	
	<!-- 댓글 저장하기 -->
	<insert id="insertComment">
		INSERT INTO comments (pid, ccid, ccontents, cuser_no, cd)
		VALUES (#{pid}, #{ccid, jdbcType=NULL}, #{ccontents}, #{cuser_no}, SYSDATE)
	</insert>
	
	<!-- 댓글 삭제하기 -->
	<delete id="deleteComment">
		DELETE FROM comments WHERE cid=#{cid}
	</delete>
	
	<!-- 특정 게시글의 댓글 개수 불러오기 -->
	<select id="getCommentCount" resultType="int">
		SELECT COUNT(*)
		FROM Comments c
		JOIN Posts p ON c.pid = p.pid
		WHERE p.pid = #{pid}
	</select>

</mapper>
 